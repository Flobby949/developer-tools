# 部署配置

<cite>
**本文档引用的文件**  
- [DEPLOY.md](file://DEPLOY.md)
- [vite.config.ts](file://vite.config.ts)
- [package.json](file://package.json)
</cite>

## 目录
1. [构建与输出流程](#构建与输出流程)  
2. [Vite部署配置详解](#vite部署配置详解)  
3. [主流平台部署指南](#主流平台部署指南)  
4. [服务器配置示例](#服务器配置示例)  
5. [安全性配置要求](#安全性配置要求)  
6. [部署验证清单](#部署验证清单)

## 构建与输出流程

根据 `DEPLOY.md` 文档，项目通过标准构建命令生成生产环境静态资源：

```bash
npm run build:prod
```

该命令执行以下操作：
- 调用 Vite 的构建流程
- 生成优化后的静态资源文件
- 输出至 `dist/` 目录

构建完成后，`dist/` 目录将包含所有前端静态资源，包括 HTML、JavaScript、CSS 和媒体文件，适用于部署到任意静态文件服务器。

**Section sources**
- [DEPLOY.md](file://DEPLOY.md#L0-L85)
- [package.json](file://package.json#L10-L15)
- [vite.config.ts](file://vite.config.ts#L15-L17)

## Vite部署配置详解

`vite.config.ts` 文件中包含多项关键部署配置，直接影响构建输出和运行时行为。

### Base路径设置

```typescript
base: '/tools/',
```

此配置指定应用的公共基础路径为 `/tools/`，确保所有静态资源（JS、CSS、图片等）的引用路径正确指向子目录。若需动态配置，可通过环境变量实现：

```typescript
base: process.env.VITE_BASE_PATH || '/tools/',
```

### 压缩与性能优化

- **压缩工具**: 使用 `esbuild` 进行代码压缩（`minify: 'esbuild'`），在构建速度与压缩效率之间取得平衡。
- **资源内联阈值**: 小于 4096 字节的资源将被内联为 base64 数据，减少 HTTP 请求次数。
- **手动分包**: 通过 `manualChunks` 配置将核心依赖（如 Vue、Pinia）和 Monaco Editor 单独打包，提升缓存效率和加载性能。

### 输出目录

```typescript
outDir: 'dist'
```

明确指定构建输出目录为 `dist`，便于自动化部署脚本识别和上传。

**Section sources**
- [vite.config.ts](file://vite.config.ts#L1-L37)
- [DEPLOY.md](file://DEPLOY.md#L4-L10)

## 主流平台部署指南

### GitHub Pages

1. 在项目根目录创建 `deploy.sh` 脚本或使用 GitHub Actions。
2. 构建命令：
   ```bash
   npm run build:prod
   ```
3. 配置 `gh-pages` 分支发布 `dist/` 目录。
4. 确保 `base` 路径与仓库名匹配（如仓库名为 `program-tool`，则 `base: '/program-tool/'`）。

### Vercel

1. 导入项目后自动检测为 Vite 项目。
2. 设置构建命令：`npm run build:prod`
3. 输出目录：`dist`
4. 环境变量（可选）：
   - `VITE_BASE_PATH=/tools/`
5. 部署后访问 `https://your-project.vercel.app/tools/`

### Netlify

1. 创建新站点，连接代码仓库。
2. 构建设置：
   - 构建命令：`npm run build:prod`
   - 发布目录：`dist`
3. 在 `netlify.toml` 中配置重定向以支持 SPA 路由：
   ```toml
   [[redirects]]
     from = "/tools/*"
     to = "/tools/index.html"
     status = 200
   ```

**Section sources**
- [DEPLOY.md](file://DEPLOY.md#L0-L85)
- [vite.config.ts](file://vite.config.ts#L15-L17)

## 服务器配置示例

为确保单页应用（SPA）路由正常工作，服务器必须将未匹配的请求回退到 `index.html`。

### Nginx 配置

```nginx
location /tools/ {
    alias /path/to/your/dist/;
    try_files $uri $uri/ /tools/index.html;

    # 静态资源长期缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

### Apache 配置

```apache
Alias /tools /path/to/your/dist
<Directory "/path/to/your/dist">
    Options Indexes FollowSymLinks
    AllowOverride All
    Require all granted

    # 支持 SPA 路由
    FallbackResource /tools/index.html
</Directory>
```

**Section sources**
- [DEPLOY.md](file://DEPLOY.md#L20-L45)

## 安全性配置要求

### HTTPS 强制启用

- 所有生产环境部署必须通过 HTTPS 提供服务。
- 可通过 Let's Encrypt 免费获取 SSL 证书，或使用托管平台（如 Vercel、Netlify）提供的自动 HTTPS。

### 内容安全策略 (CSP)

建议在服务器响应头中添加 CSP 策略，防止 XSS 攻击。例如：

```http
Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; object-src 'none'; frame-ancestors 'none';
```

此策略限制资源仅从同源加载，并禁止嵌入框架，增强应用安全性。

**Section sources**
- [DEPLOY.md](file://DEPLOY.md#L103-L109)
- [SECURITY_GUIDE.md](file://SECURITY_GUIDE.md#L0-L239)

## 部署验证清单

部署完成后，按以下清单进行验证：

- [ ] **首页访问**: 访问 `https://your-domain.com/tools/`，确认页面正常加载。
- [ ] **路由测试**: 手动刷新 `/tools/json` 等子页面，确认不出现 404 错误（验证路由回退配置）。
- [ ] **资源加载**: 检查浏览器开发者工具的 Network 面板，确认 JS、CSS 文件状态码为 200。
- [ ] **HTTPS 检查**: 确认地址栏显示安全锁标志，所有请求均为 HTTPS。
- [ ] **CSP 头部**: 在 Response Headers 中检查是否存在 `Content-Security-Policy`。
- [ ] **缓存策略**: 验证静态资源（如 `.js`, `.css`）是否返回 `Cache-Control` 和 `Expires` 头部。
- [ ] **功能完整性**: 测试至少一个核心工具（如 JSON 格式化）确保功能正常。

完成以上检查后，生产环境部署即视为成功。

**Section sources**
- [DEPLOY.md](file://DEPLOY.md#L60-L85)